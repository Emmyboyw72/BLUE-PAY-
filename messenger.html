<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Messenger • BluePay</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue-primary: #1a73e8;
      --blue-dark: #0d47a1;
      --blue-light: #e8f0fe;
      --white: #ffffff;
      --text-gray: #2d2d2d;
      --border-gray: #e0e6ed;
      --bg-light: #fafbff;
      --red-badge: #ea4335;
      --green-seen: #07bc0c;
      --gray-light: #f5f7fa;
      --gray-medium: #e4e7eb;
      --gray-dark: #9aa4b2;
      --message-bg: #f1f3f4;
      --message-text: #202124;
      --sent-message-bg: var(--blue-primary);
      --sent-message-text: white;
      --deleted-message-bg: #f8f9fa;
      --deleted-message-text: #6c757d;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background-color: var(--bg-light);
      color: var(--text-gray);
      min-height: 100vh;
      padding: 0;
      margin: 0;
      touch-action: manipulation;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .chat-header {
      background: linear-gradient(120deg, var(--blue-primary), var(--blue-dark));
      color: white;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(26, 115, 232, 0.22);
      display: flex;
      align-items: center;
    }

    .back-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      margin-right: 16px;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .header-info {
      flex: 1;
    }

    .recipient-name {
      font-weight: 600;
      font-size: 1.2rem;
      margin-bottom: 2px;
    }

    .online-status {
      display: flex;
      align-items: center;
      font-size: 0.85rem;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .online {
      background-color: var(--green-seen);
    }

    .offline {
      background-color: var(--gray-medium);
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      background-color: var(--gray-light);
    }

    /* Message Bubble */
    .message {
      max-width: 75%;
      padding: 10px 14px;
      margin-bottom: 12px;
      border-radius: 18px;
      position: relative;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .received {
      background-color: var(--message-bg);
      color: var(--message-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .sent {
      background-color: var(--sent-message-bg);
      color: var(--sent-message-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .deleted {
      background-color: var(--deleted-message-bg) !important;
      color: var(--deleted-message-text) !important;
      font-style: italic;
    }

    .message-text {
      font-size: 1rem;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .reply-preview {
      background-color: rgba(0,0,0,0.05);
      padding: 6px 10px;
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: #5f6368;
    }

    .reply-preview.sent {
      background-color: rgba(255,255,255,0.2);
    }

    .reply-preview .reply-author {
      font-weight: 600;
      margin-right: 6px;
    }

    .message-time {
      font-size: 0.7rem;
      margin-top: 4px;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sent .message-time {
      color: rgba(255, 255, 255, 0.8);
    }

    .read-receipt {
      display: flex;
      align-items: center;
      font-size: 0.7rem;
      margin-left: 4px;
    }

    .read-receipt-icon {
      margin-right: 2px;
    }

    .seen-text {
      color: var(--green-seen);
      font-size: 0.65rem;
      margin-left: 2px;
    }

    .message-actions {
      position: absolute;
      top: -32px;
      right: 0;
      background: white;
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 4px 0;
      display: none;
      z-index: 10;
      min-width: 120px;
    }

    .message:hover .message-actions {
      display: block;
    }

    .action-item {
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
      display: flex;
      align-items: center;
    }

    .action-item:hover {
      background-color: var(--blue-light);
    }

    .action-icon {
      margin-right: 8px;
      font-size: 14px;
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      background-color: var(--message-bg);
      border-radius: 18px;
      align-self: flex-start;
      margin-bottom: 12px;
      max-width: 120px;
    }

    .typing-dots {
      display: flex;
      margin-left: 8px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: var(--gray-dark);
      border-radius: 50%;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }

    /* Input Area */
    .input-area {
      background: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      border-top: 1px solid var(--border-gray);
      position: sticky;
      bottom: 0;
      z-index: 100;
    }

    .replying-to {
      background: var(--blue-light);
      padding: 8px 12px;
      border-radius: 16px;
      margin-bottom: 10px;
      display: none;
      width: 100%;
    }

    .replying-to-content {
      font-size: 0.85rem;
      color: var(--blue-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .replying-to-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 80%;
    }

    .cancel-reply {
      background: none;
      border: none;
      color: var(--blue-primary);
      font-weight: bold;
      cursor: pointer;
    }

    .message-input {
      flex: 1;
      border: 1px solid var(--border-gray);
      border-radius: 24px;
      padding: 12px 16px;
      font-size: 1rem;
      resize: none;
      height: 50px;
      max-height: 120px;
      outline: none;
      transition: border-color 0.2s;
    }

    .message-input:focus {
      border-color: var(--blue-primary);
    }

    .send-button {
      background: linear-gradient(135deg, var(--blue-primary), var(--blue-dark));
      color: white;
      border: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-left: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(26, 115, 232, 0.3);
    }

    .send-button:hover {
      transform: scale(1.05);
    }

    .send-button:active {
      transform: scale(0.95);
    }

    .send-icon {
      font-size: 20px;
    }

    /* Selection Mode */
    .selection-mode {
      background: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--border-gray);
      display: none;
    }

    .selection-info {
      font-weight: 600;
      color: var(--blue-primary);
    }

    .selection-actions {
      display: flex;
      gap: 12px;
    }

    .selection-btn {
      background: var(--blue-light);
      border: none;
      border-radius: 20px;
      padding: 6px 16px;
      font-weight: 600;
      color: var(--blue-primary);
      cursor: pointer;
    }

    .selection-btn.delete {
      background: rgba(234, 67, 53, 0.1);
      color: var(--red-badge);
    }

    /* Message Selection */
    .message.selected {
      outline: 2px solid var(--blue-primary);
      outline-offset: -2px;
    }

    /* Empty State */
    .empty-chat {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px 20px;
      text-align: center;
      color: #777;
    }

    .empty-chat h3 {
      color: var(--blue-primary);
      margin-bottom: 10px;
    }

    .empty-chat p {
      max-width: 300px;
      line-height: 1.5;
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.96);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(3px);
    }

    .loader {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(26,115,232,0.2);
      border-top-color: var(--blue-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Alert Styles */
    .alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(26, 115, 232, 0.15);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }

    .alert {
      background: white;
      border-radius: 20px;
      padding: 32px;
      width: 90%;
      max-width: 480px;
      text-align: center;
      box-shadow: 0 12px 40px rgba(26, 115, 232, 0.25);
      border: 2px solid var(--blue-light);
    }

    .alert h2 {
      color: var(--blue-primary);
      margin-bottom: 18px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
    }

    .alert p {
      margin-bottom: 24px;
      line-height: 1.5;
      color: #444;
      font-size: 1rem;
    }

    .alert-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .alert-button {
      background: linear-gradient(135deg, var(--blue-primary), var(--blue-dark));
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
    }

    .alert-button.secondary {
      background: var(--gray-light);
      color: var(--text-gray);
    }

    .alert-button:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }

    /* Delete Options Modal */
    .delete-options-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      display: none;
    }

    .delete-options-content {
      background: white;
      border-radius: 20px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .delete-options-content h3 {
      color: var(--blue-primary);
      margin-bottom: 16px;
      font-size: 1.4rem;
    }

    .delete-option {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-gray);
    }

    .delete-option:last-child {
      border-bottom: none;
    }

    .delete-option input {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      accent-color: var(--blue-primary);
    }

    .delete-option label {
      flex: 1;
      font-size: 1rem;
      color: var(--text-gray);
    }

    .delete-option-description {
      font-size: 0.85rem;
      color: #666;
      margin-top: 4px;
      display: block;
    }

    .delete-options-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .delete-options-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .delete-options-btn.cancel {
      background: var(--gray-light);
      color: var(--text-gray);
    }

    .delete-options-btn.delete {
      background: linear-gradient(135deg, var(--blue-primary), var(--blue-dark));
      color: white;
    }

    .delete-options-btn.delete:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }

    /* Long press indicator */
    .long-press-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 500;
      display: none;
    }

    .long-press-content {
      background: white;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .long-press-content p {
      margin-bottom: 15px;
      color: var(--text-gray);
    }

    .long-press-actions {
      display: flex;
      gap: 15px;
    }

    .long-press-btn {
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .long-press-btn.reply {
      background: var(--blue-light);
      color: var(--blue-primary);
    }

    .long-press-btn.delete {
      background: rgba(234, 67, 53, 0.1);
      color: var(--red-badge);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .chat-header {
        padding: 12px 16px;
      }
      
      .recipient-name {
        font-size: 1.1rem;
      }
      
      .message {
        max-width: 85%;
      }
      
      .message-input {
        height: 44px;
      }
      
      .send-button {
        width: 42px;
        height: 42px;
      }
    }
  </style>
</head>
<body>
  <div class="chat-header">
    <button class="back-btn" id="backBtn">←</button>
    <div class="header-info">
      <div class="recipient-name" id="recipientName">Loading...</div>
      <div class="online-status">
        <div class="status-indicator offline" id="statusIndicator"></div>
        <span id="statusText">Offline</span>
      </div>
    </div>
  </div>

  <div class="chat-container" id="chatContainer">
    <!-- Messages will be loaded here -->
  </div>

  <div class="selection-mode" id="selectionMode">
    <div class="selection-info" id="selectionInfo">0 selected</div>
    <div class="selection-actions">
      <button class="selection-btn delete" id="deleteSelected">Delete</button>
      <button class="selection-btn" id="cancelSelection">Cancel</button>
    </div>
  </div>

  <div class="input-area">
    <div class="replying-to" id="replyingTo">
      <div class="replying-to-content">
        <div class="replying-to-text" id="replyingToText">Replying to...</div>
        <button class="cancel-reply" id="cancelReply">✕</button>
      </div>
    </div>
    <textarea class="message-input" id="messageInput" placeholder="Type a message..."></textarea>
    <button class="send-button" id="sendButton">
      <span class="send-icon">➤</span>
    </button>
  </div>

  <!-- Delete Options Modal -->
  <div class="delete-options-modal" id="deleteOptionsModal">
    <div class="delete-options-content">
      <h3>Delete Message</h3>
      <div class="delete-option">
        <input type="radio" id="deleteForMe" name="deleteOption" checked>
             <label for="deleteForMe">
        Delete for me
        <span class="delete-option-description">Only you will see this message removed</span>
      </label>
    </div>
    <div class="delete-option">
      <input type="radio" id="deleteForEveryone" name="deleteOption">
      <label for="deleteForEveryone">
        Delete for everyone
        <span class="delete-option-description">Both you and the recipient will see this message removed</span>
      </label>
    </div>
    <div class="delete-options-actions">
      <button class="delete-options-btn cancel" id="cancelDelete">Cancel</button>
      <button class="delete-options-btn delete" id="confirmDelete">Delete</button>
    </div>
  </div>
</div>

<!-- Long Press Indicator -->
<div class="long-press-indicator" id="longPressIndicator">
  <div class="long-press-content">
    <p>Select an action</p>
    <div class="long-press-actions">
      <button class="long-press-btn reply" id="longPressReply">Reply</button>
      <button class="long-press-btn delete" id="longPressDelete">Delete</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>

<script>
  // 🔑 Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCusJ_rFuOWwy1QFZedtyJr7igCeiIg3a0",
    authDomain: "my-sign-up-and-login.firebaseapp.com",
    projectId: "my-sign-up-and-login",
    storageBucket: "my-sign-up-and-login.firebasestorage.app",
    messagingSenderId: "1009128333653",
    appId: "1:1009128333653:web:15c1609ca3fbd4720c0fdc"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  
  // DOM Elements
  const chatContainer = document.getElementById('chatContainer');
  const messageInput = document.getElementById('messageInput');
  const sendButton = document.getElementById('sendButton');
  const replyingTo = document.getElementById('replyingTo');
  const replyingToText = document.getElementById('replyingToText');
  const cancelReply = document.getElementById('cancelReply');
  const recipientName = document.getElementById('recipientName');
  const statusIndicator = document.getElementById('statusIndicator');
  const statusText = document.getElementById('statusText');
  const backBtn = document.getElementById('backBtn');
  const deleteOptionsModal = document.getElementById('deleteOptionsModal');
  const confirmDelete = document.getElementById('confirmDelete');
  const cancelDelete = document.getElementById('cancelDelete');
  const longPressIndicator = document.getElementById('longPressIndicator');
  const longPressReply = document.getElementById('longPressReply');
  const longPressDelete = document.getElementById('longPressDelete');
  const selectionMode = document.getElementById('selectionMode');
  const selectionInfo = document.getElementById('selectionInfo');
  const deleteSelected = document.getElementById('deleteSelected');
  const cancelSelection = document.getElementById('cancelSelection');
  
  // State variables
  let currentUser = null;
  let recipient = null;
  let chatId = null;
  let replyToMessage = null;
  let selectedMessages = [];
  let longPressTimer = null;
  let currentLongPressMessage = null;
  let typingIndicator = null;
  let isTyping = false;
  let typingTimeout = null;
  
  // Initialize the chat - WAIT for auth state to be ready
  function initChat() {
    showLoading();
    
    // Wait for Firebase auth to initialize
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        hideLoading();
        showBeautifulAlert("Not Signed In", "You need to be signed in to send messages.", "Go to Login", () => {
          window.location.href = 'login.html';
        });
        return;
      }
      
      currentUser = user;
      
      try {
        // Get recipient from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const recipientId = urlParams.get('to');
        if (!recipientId) {
          hideLoading();
          showBeautifulAlert("Error", "Recipient not specified", "OK", () => {
            window.location.href = 'friends.html';
          });
          return;
        }
        
        // Get recipient data
        const recipientDoc = await db.collection('users').doc(recipientId).get();
        if (!recipientDoc.exists) {
          hideLoading();
          showBeautifulAlert("Error", "Recipient not found", "OK", () => {
            window.location.href = 'friends.html';
          });
          return;
        }
        
        recipient = recipientDoc.data();
        recipient.uid = recipientId;
        
        // Set chat header info
        recipientName.textContent = recipient.email === "bluepay863@gmail.com" ? "BluePay Admin" : recipient.name;
        statusIndicator.classList.remove('offline');
        statusIndicator.classList.add('online');
        statusText.textContent = "Online";
        
        // Create chat ID (sorted to ensure consistency)
        chatId = [currentUser.uid, recipientId].sort().join('_');
        
        // Set up real-time listener for messages
        setupMessageListener();
        
        // Set up typing indicator listener
        setupTypingListener();
        
        // Set up event listeners
        setupEventListeners();
        
        // Mark messages as read
        await markMessagesAsRead();
        
        // Hide loading after a short delay for better UX
        setTimeout(hideLoading, 500);
      } catch (error) {
        console.error("Error initializing chat:", error);
        hideLoading();
        showBeautifulAlert("Error", "Failed to load chat. Please try again.", "OK", () => {
          window.location.href = 'friends.html';
        });
      }
    });
  }
  
  // Set up real-time message listener
  function setupMessageListener() {
    const messagesRef = db.collection('chats').doc(chatId).collection('messages')
      .orderBy('timestamp', 'asc');
    
    messagesRef.onSnapshot((snapshot) => {
      renderMessages(snapshot.docs);
    });
  }
  
  // Set up typing indicator listener
  function setupTypingListener() {
    const typingRef = db.collection('chats').doc(chatId).collection('typing').doc(recipient.uid);
    
    typingRef.onSnapshot((doc) => {
      if (doc.exists) {
        const data = doc.data();
        if (data.isTyping && data.timestamp) {
          // Check if typing is still recent (within last 5 seconds)
          const now = new Date().getTime();
          const typingTime = data.timestamp.toDate().getTime();
          if (now - typingTime < 5000) {
            showTypingIndicator();
          } else {
            hideTypingIndicator();
          }
        } else {
          hideTypingIndicator();
        }
      } else {
        hideTypingIndicator();
      }
    });
  }
  
  // Render messages from snapshot
  function renderMessages(docs) {
    chatContainer.innerHTML = '';
    
    if (docs.length === 0) {
      chatContainer.innerHTML = `
        <div class="empty-chat">
          <h3>No messages yet</h3>
          <p>Send a message to start the conversation!</p>
        </div>
      `;
      return;
    }
    
    docs.forEach(doc => {
      const msg = doc.data();
      msg.id = doc.id;
      const messageElement = createMessageElement(msg);
      chatContainer.appendChild(messageElement);
    });
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
  
  // Create a message element
  function createMessageElement(msg) {
    const isSent = msg.senderId === currentUser.uid;
    const isDeleted = msg.deleted;
    const messageClass = isSent ? 'sent' : 'received';
    const messageElement = document.createElement('div');
    messageElement.className = `message ${messageClass} ${isDeleted ? 'deleted' : ''}`;
    messageElement.dataset.messageId = msg.id;
    
    // Add reply preview if this message is a reply
    if (msg.replyTo) {
      const replyPreview = document.createElement('div');
      replyPreview.className = `reply-preview ${isSent ? 'sent' : ''}`;
      
      const replyAuthor = msg.replyToSender === currentUser.uid ? 'You' : 
        (recipient.email === "bluepay863@gmail.com" ? "BluePay Admin" : recipient.name);
      
      replyPreview.innerHTML = `
        <span class="reply-author">${replyAuthor}:</span>
        ${msg.replyToText || 'Message content'}
      `;
      messageElement.appendChild(replyPreview);
    }
    
    // Message text
    const messageText = document.createElement('div');
    messageText.className = 'message-text';
    messageText.textContent = isDeleted ? 'This message was deleted' : msg.text;
    messageElement.appendChild(messageText);
    
    // Message time and read receipt
    const timeElement = document.createElement('div');
    timeElement.className = 'message-time';
    timeElement.textContent = formatTime(msg.timestamp);
    
    if (isSent && msg.readBy && msg.readBy.includes(recipient.uid)) {
      timeElement.innerHTML += `
        <span class="read-receipt">
          <span class="read-receipt-icon">✓✓</span>
          <span class="seen-text">seen</span>
        </span>
      `;
    }
    
    messageElement.appendChild(timeElement);
    
    // Message actions (reply/delete) - ONLY show delete for own messages
    const actionsElement = document.createElement('div');
    actionsElement.className = 'message-actions';
    actionsElement.innerHTML = `
      <div class="action-item" data-action="reply">
        <span class="action-icon">↩️</span> Reply
      </div>
    `;
    
    // Only add delete option for own messages
    if (isSent) {
      actionsElement.innerHTML += `
        <div class="action-item" data-action="delete">
          <span class="action-icon">🗑️</span> Delete
        </div>
      `;
    }
    
    messageElement.appendChild(actionsElement);
    
    // Add event listeners for actions
    actionsElement.querySelector('[data-action="reply"]').addEventListener('click', (e) => {
      e.stopPropagation();
      setReplyTo(msg);
    });
    
    // Only add delete listener for own messages
    const deleteAction = actionsElement.querySelector('[data-action="delete"]');
    if (deleteAction) {
      deleteAction.addEventListener('click', (e) => {
        e.stopPropagation();
        showDeleteOptions(msg);
      });
    }
    
    // Add long press functionality
    messageElement.addEventListener('touchstart', (e) => {
      currentLongPressMessage = msg;
      longPressTimer = setTimeout(() => {
        showLongPressIndicator(msg);
      }, 500);
    });
    
    messageElement.addEventListener('touchend', () => {
      clearTimeout(longPressTimer);
    });
    
    messageElement.addEventListener('touchmove', () => {
      clearTimeout(longPressTimer);
    });
    
    // For desktop
    messageElement.addEventListener('mousedown', (e) => {
      if (e.button === 0) { // Left mouse button
        currentLongPressMessage = msg;
        longPressTimer = setTimeout(() => {
          showLongPressIndicator(msg);
        }, 500);
      }
    });
    
    messageElement.addEventListener('mouseup', () => {
      clearTimeout(longPressTimer);
    });
    
    messageElement.addEventListener('mouseleave', () => {
      clearTimeout(longPressTimer);
    });
    
    // Selection mode - ONLY allow selection of own messages
    messageElement.addEventListener('click', () => {
      if (selectionMode.style.display === 'flex' && msg.senderId === currentUser.uid) {
        toggleMessageSelection(msg.id);
      }
    });
    
    return messageElement;
  }
  
  // Format time for display
  function formatTime(timestamp) {
    if (!timestamp) return "";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  // Set reply to a message
  function setReplyTo(message) {
    replyToMessage = message;
    replyingTo.style.display = 'block';
    replyingToText.textContent = message.text.length > 30 ? 
      message.text.substring(0, 30) + '...' : 
      message.text;
    messageInput.focus();
  }
  
  // Cancel reply
  function cancelReplyTo() {
    replyToMessage = null;
    replyingTo.style.display = 'none';
    messageInput.focus();
  }
  
  // Send a new message
  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;
    
    // Hide typing indicator if it exists
    hideTypingIndicator();
    
    // Create new message object
    const newMessage = {
      text: text,
      senderId: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [],
      replyTo: replyToMessage ? replyToMessage.id : null,
      replyToSender: replyToMessage ? replyToMessage.senderId : null,
      replyToText: replyToMessage ? replyToMessage.text : null
    };
    
    try {
      // Add message to Firestore
      await db.collection('chats').doc(chatId).collection('messages').add(newMessage);
      
      // Clear input and cancel reply
      messageInput.value = '';
      cancelReplyTo();
    } catch (error) {
      console.error("Error sending message:", error);
      showBeautifulAlert("Error", "Failed to send message. Please try again.");
    }
  }
  
  // Show typing indicator
  function showTypingIndicator() {
    // Only show if we're not the one typing
    if (currentUser.uid === recipient.uid) return;
    
    // Remove existing typing indicator if any
    if (typingIndicator && typingIndicator.parentNode) {
      typingIndicator.remove();
    }
    
    typingIndicator = document.createElement('div');
    typingIndicator.className = 'typing-indicator';
    typingIndicator.innerHTML = `
      <span>Typing</span>
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    chatContainer.appendChild(typingIndicator);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
  
  // Hide typing indicator
  function hideTypingIndicator() {
    if (typingIndicator && typingIndicator.parentNode) {
      typingIndicator.remove();
      typingIndicator = null;
    }
  }
  
  // Mark messages as read
  async function markMessagesAsRead() {
    try {
      const messagesRef = db.collection('chats').doc(chatId).collection('messages');
      const unreadMessages = await messagesRef
        .where('senderId', '==', recipient.uid)
        .get();
      
      const batch = db.batch();
      unreadMessages.forEach(doc => {
        const data = doc.data();
        if (!data.readBy || !data.readBy.includes(currentUser.uid)) {
          batch.update(doc.ref, {
            readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
          });
        }
      });
      
      await batch.commit();
    } catch (error) {
      console.error("Error marking messages as read:", error);
    }
  }
  
  // Show delete options modal
  function showDeleteOptions(message) {
    // Only allow deletion of own messages
    if (message.senderId !== currentUser.uid) {
      showBeautifulAlert("Permission Denied", "You can only delete your own messages.");
      return;
    }
    
    currentLongPressMessage = message;
    deleteOptionsModal.style.display = 'flex';
  }
  
  // Confirm deletion
  async function confirmDeletion() {
    // Only allow deletion of own messages
    if (currentLongPressMessage.senderId !== currentUser.uid) {
      showBeautifulAlert("Permission Denied", "You can only delete your own messages.");
      deleteOptionsModal.style.display = 'none';
      return;
    }
    
    const deleteForEveryone = document.getElementById('deleteForEveryone').checked;
    
    try {
      if (deleteForEveryone) {
        // Only allow deleting own messages for everyone
        await db.collection('chats').doc(chatId).collection('messages').doc(currentLongPressMessage.id).update({
          deleted: true,
          deletedForEveryone: true
        });
      } else {
        // Mark as deleted only for current user
        await db.collection('chats').doc(chatId).collection('messages').doc(currentLongPressMessage.id).update({
          deleted: true
        });
      }
      
      deleteOptionsModal.style.display = 'none';
    } catch (error) {
      console.error("Error deleting message:", error);
      showBeautifulAlert("Error", "Failed to delete message. Please try again.");
      deleteOptionsModal.style.display = 'none';
    }
  }
  
  // Show long press indicator
  function showLongPressIndicator(message) {
    currentLongPressMessage = message;
    
    // Only show delete option for own messages
    if (message.senderId === currentUser.uid) {
      longPressDelete.style.display = 'inline-block';
    } else {
      longPressDelete.style.display = 'none';
    }
    
    longPressIndicator.style.display = 'flex';
  }
  
  // Handle long press reply
  function handleLongPressReply() {
    setReplyTo(currentLongPressMessage);
    longPressIndicator.style.display = 'none';
  }
  
  // Handle long press delete
  function handleLongPressDelete() {
    // Only allow deletion of own messages
    if (currentLongPressMessage.senderId !== currentUser.uid) {
      showBeautifulAlert("Permission Denied", "You can only delete your own messages.");
      longPressIndicator.style.display = 'none';
      return;
    }
    
    showDeleteOptions(currentLongPressMessage);
    longPressIndicator.style.display = 'none';
  }
  
  // Toggle message selection
  function toggleMessageSelection(messageId) {
    // Only allow selection of own messages
    const message = messages.find(m => m.id === messageId);
    if (message && message.senderId !== currentUser.uid) return;
    
    const index = selectedMessages.indexOf(messageId);
    if (index === -1) {
      selectedMessages.push(messageId);
    } else {
      selectedMessages.splice(index, 1);
    }
    
    updateSelectionUI();
  }
  
  // Update selection UI
  function updateSelectionUI() {
    selectionInfo.textContent = `${selectedMessages.length} selected`;
    
    document.querySelectorAll('.message').forEach(msgEl => {
      const msgId = msgEl.dataset.messageId;
      if (selectedMessages.includes(msgId)) {
        msgEl.classList.add('selected');
      } else {
        msgEl.classList.remove('selected');
      }
    });
    
    if (selectedMessages.length > 0) {
      selectionMode.style.display = 'flex';
    } else {
      selectionMode.style.display = 'none';
    }
  }
  
  // Delete selected messages
  async function deleteSelectedMessages() {
    try {
      const batch = db.batch();
      selectedMessages.forEach(msgId => {
        // Only delete own messages
        const message = messages.find(m => m.id === msgId);
        if (message && message.senderId === currentUser.uid) {
          const msgRef = db.collection('chats').doc(chatId).collection('messages').doc(msgId);
          batch.update(msgRef, { deleted: true });
        }
      });
      
      await batch.commit();
      
      selectedMessages = [];
      updateSelectionUI();
    } catch (error) {
      console.error("Error deleting selected messages:", error);
      showBeautifulAlert("Error", "Failed to delete messages. Please try again.");
    }
  }
  
  // Cancel selection mode
  function cancelSelectionMode() {
    selectedMessages = [];
    updateSelectionUI();
  }
  
  // Setup event listeners
  function setupEventListeners() {
    sendButton.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
        // Send typing indicator when user is typing
    messageInput.addEventListener('input', () => {
      if (!isTyping) {
        isTyping = true;
        sendTypingIndicator(true);
      }
      
      if (typingTimeout) {
        clearTimeout(typingTimeout);
      }
      
      typingTimeout = setTimeout(() => {
        isTyping = false;
        sendTypingIndicator(false);
      }, 3000);
    });
    
    cancelReply.addEventListener('click', cancelReplyTo);
    
    confirmDelete.addEventListener('click', confirmDeletion);
    cancelDelete.addEventListener('click', () => {
      deleteOptionsModal.style.display = 'none';
    });
    
    longPressReply.addEventListener('click', handleLongPressReply);
    longPressDelete.addEventListener('click', handleLongPressDelete);
    
    deleteSelected.addEventListener('click', deleteSelectedMessages);
    cancelSelection.addEventListener('click', cancelSelectionMode);
    
    backBtn.addEventListener('click', () => {
      window.location.href = 'friends.html';
    });
    
    longPressIndicator.addEventListener('click', (e) => {
      if (e.target === longPressIndicator) {
        longPressIndicator.style.display = 'none';
      }
    });
    
    deleteOptionsModal.addEventListener('click', (e) => {
      if (e.target === deleteOptionsModal) {
        deleteOptionsModal.style.display = 'none';
      }
    });
  }
  
  // Send typing indicator to Firestore
  async function sendTypingIndicator(isTyping) {
    try {
      await db.collection('chats').doc(chatId).collection('typing').doc(currentUser.uid).set({
        isTyping: isTyping,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    } catch (error) {
      console.error("Error sending typing indicator:", error);
    }
  }
  
  // Show loading screen
  function showLoading() {
    document.body.insertAdjacentHTML('beforeend', `
      <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div>Loading chat...</div>
      </div>
    `);
  }
  
  // Hide loading screen
  function hideLoading() {
    const el = document.getElementById('loadingScreen');
    if (el) el.remove();
  }
  
  // Show beautiful alert
  function showBeautifulAlert(title, message, buttonText = "OK", callback = null) {
    const overlay = document.createElement('div');
    overlay.className = 'alert-overlay';
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert';
    alertDiv.innerHTML = `
      <h2>${title}</h2>
      <p>${message}</p>
      <button class="alert-button">${buttonText}</button>
    `;
    overlay.appendChild(alertDiv);
    document.body.appendChild(overlay);

    const button = alertDiv.querySelector('.alert-button');
    button.addEventListener('click', () => {
      document.body.removeChild(overlay);
      if (callback) callback();
    });
    
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        document.body.removeChild(overlay);
        if (callback) callback();
      }
    });
  }
  
  // Initialize the chat when the page loads
  window.addEventListener('DOMContentLoaded', initChat);
</script>
</body>
</html>